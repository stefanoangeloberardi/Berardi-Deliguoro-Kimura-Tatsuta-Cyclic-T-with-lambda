

\newpage

\section{Infinite Church-Rosser for Infinite Lambda Terms}
\label{section-safe-church-rosser}

%15:12 16/04/2024
In this section prove a result for the safe part of a term, which we call 
\quotationMarks{\emph{unicity of the safe part of the safe normal form}}. By this we mean:
for all $t,u,v \in \LAMBDA$, if $t \reduces u$ and $t \reduces v$ and $u$, $v$ are safe-normal 
then $u$, $v$ are equal outside the right-hand side of all $\cond$-sub-terms. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%
%\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots
%\\
%\bfColor{red}{(Here we should fill this part by adapting the proof of Church Rosser for the type $\N$- Stefano)}
%\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots\ldots
%%15:46 24/04/2024
%%%%%%%%%%%%%%%%%%%%%%%%%%%

Our first idea (wrong) is to prove a full Church-Rosser property for $\LAMBDA$: 
for all $t,u,v \in \LAMBDA$, if $t \reduces u$ and $t \reduces v$ then for some $w \in \LAMBDA$
we have $u \reduces w$ and $v \reduces w$. This property is false: for some $t \in \LAMBDA$, finding a 
common reduction of $u$, $v$ takes infinitely many steps. This even in the case $t \in \CTlambda$,
as the next example shows.

\begin{Eg}[Failure of Church-Rosser for $\CTlambda$]
Let $b = \cond(x^{\N},b):\N \rightarrow \N$ a normal form
and $t = (\lambda x^{\N}.b)(r):\N \rightarrow \N$, 
where $r = (\lambda x^{\N}.x^{\N})(3)$ is some redex. 

We have $b[r/x](n) \reduces r \reduces 3$ for all numerals $n$, 
therefore $t$ and $\lambda \_.3$ are extensionally equal, however $t \not \reduces \lambda \_.3$. 
We have $t \in \CTlambda$. Indeed, 
\begin{enumerate}
\item
$t$ is regular by construction.
\item
We have $t \in \GTC$, because the unique infinite path of $t$ is 
$t, \lambda x^{\N}.b, b, b, b, \ldots$, and the
unique unnamed argument of $b:\N \rightarrow \N$ in the path progresses infinitely many times.
\end{enumerate}

Now consider the reductions: $t \reduces b[r/x^\N]$ and $t \reduces  (\lambda x^{\N}.b)(3)$.
We expect $b[3/x^\N]$ as common normal form. But we have $b[r/x^\N] = \cond(r,b[r/x^\N]$,
that is, we have replicated the redex $r$ infinitely many times in $b[r/x^\N]$. Therefore to reduce 
$b[r/x^\N]$ to $b[3/x^\N]$ takes infinitely many steps, and for \emph{no finite reduction we have}
$b[r/x^\N] \reduces b[3/x^\N]$. 

We proved that Church-Rosser is false for $\CTlambda$.
\end{Eg}

In order to recover Church-Rosser we have to consider a more general notion of reduction $\reduces_X$, 
which allow to reduce \emph{infinitely many redexes in one step}: 
all those in a \emph{decidable} set $X$ of redexes of $t$, and possibly all current redexes
This reduction can generate new redexes of course. 

We will prove that $\reduces_X$ is confluent: namely, we will prove that 
if $t \reduces_X u$ and $t \reduces_Y v$, 
then for some $w, Z, T$ we will have $u \reduces_Z w$ and $v  \reduces_T w$.
We call this property Infinite Church-Rosser.
Infinite Church-Rosser will imply the unicity of the safe part of the safe normal form.

Our first problem is that infinite reductions can easily loop, therefore Infinite Church-Rosser is stated for the
set $\LAMBDA_\bot$ of terms with possibly \emph{undefinite} subterms. 
This is not an obstacle for the goals of this paper, as we will see.

We formally state Infinite Church-Rosser as follows. 
\quotationMarks{\emph{For all $t,u,v \in \LAMBDA_\bot$, all decidable sets $X$, $Y$ of redexes of $t$, 
if $t \reduces_X u$ and $t \reduces_Y v$, 
then for some $w \in \LAMBDA_\bot$, some decidable set $Z$, $T$ of redexes of $u$, $v$
we have $u \reduces_Z w$ and $v  \reduces_T w$ and $t \reduces_{X \cup Y} w$}}.

%08:00 10/06/2024

We represent a decidable set $X$ of positions of redexes, and in fact any decidable set of sub-terms by a map 
$\phi_X:\universe{t} \rightarrow \{\True,\False\}$ 
such that $l \in X$ if and only if $\phi_X(l) =\True$. 
Our first step is to precise how $\phi_X$ changes when redexes in $X$ are moved or duplicated.


\begin{definition}[Substitution, subterms and labels]
\label{definition-substitution-label}
Suppose $t, u \in \LAMBDA_\bot$
and $X$ is a decidable set of redexes of $t$ and $Y$ a decidable set of redexes of $u$.
\begin{enumerate}
\item
$Z = [Y/x]$ is a a decidable set of redexes of $t[u/x]$ defined as:
for all $l \in \universe{t}$, $m \universe{u}$:
if $l$ is a free occurrence of $x$ we set $\phi_Z(l \conc m) = \phi_Y(m)$, 
otherwise $\phi_Z(l \conc m) = \False$.

\item
$X[Y/x] = X \cup [Y/x]$.

\item
If $n=0,1,2$ and $t = c(t_1)\ldots(t_n)$ and $X$ a decidable set of redexes of $t$,
then for all $1 \le i \le n$ we define a set $X_i$ of redexes in $t_i$ by $\phi_{X_i}(l) = \phi_X((i) \conc l)$.
 
\item
If $n=0,1,2$ and $t = c(t_1)\ldots(t_n)$ 
and for all $1 \le i \le n$ $X_i$ is a decidable set of redexes of $t_i$,
then we define a set $X$ of redexes in $t$ by $\phi_X(\nil)=\False$
and $\phi_X((i) \conc l) = \phi_{X_i}(l)$. 
\end{enumerate}
\end{definition}



We define the \emph{unique} $u \in \LAMBDA_\bot$ such that 
$t \reduces_X u$ as the limit of a map $\rho(t,X,n)$ for $n \rightarrow \infty$. 
$\rho(t,X,n)$ starts with the undefined value $\bot$, then either holds the value $\bot$ forever,
or at some step the root of the term $\rho(t,X,n)$ becomes some constructor of $\LAMBDA$ and never
changes again. At each step, if $t$ itself is a redex in the set $X$ then we reduce it, 
if $t$ is not a redex in $X$ then we move to the subterms of $t$. 
In both case we update $X$ accordingly to some set of labels $X'$.
We update any other set $Z$ of labels in $t$ in the same way to some $Z'$.
We introduce a map $\sigma(t,X,n,Z)$ computing the  value for a set $Z$ of redexes after $n$ steps.
In particular we have $X' = \sigma(t,X,1,X)$.


\begin{definition}[Infinite reductions]
\label{definition-infinite-reduction}
Assume $t \in \LAMBDA_\bot$ and $X,Z$ are decidable sets of redexes of $t$.
Let $X_1, Y_1, \ldots$ as in Def. \ref{definition-substitution-label}.

We set $\rho(t,X,0)=\bot$. If  $\phi_X(t) = \True$, then we set:

\begin{enumerate}
\item
If $t = (\lambda x^T.b)(a)$, 
then 
\begin{enumerate}
\item
$\rho(t,X,n+1) \ \ \ \ = \rho(b[a/x],X',n)$
\item
$\sigma(t,X,n+1,Z) = \sigma(b[a/x],X,n, \ Z')$
\end{enumerate}
where $Z' = (Z_1)_1[Z_2/x]$.

\item
If $t = \cond(f,g)(0)$, 
then 
\begin{enumerate}
\item
$\rho(t,X,n+1) \ \ \ \ = \rho(f,X',n)$
\item
$\sigma(t,X,n+1,Z) = \sigma(f,X,n, Z')$
\end{enumerate}
where  $Z' = (Z_1)_1$.

\item
If $t = \cond(f,g)(\Succ(u))$, 
then 
\begin{enumerate}
\item
$\rho(t,X,n+1)  \ \ \ \ = \rho(g(u),X',n)$ 
\item
$\sigma(t,X,n+1,Z) =  \sigma(g(u),X,n, Z')$
\end{enumerate}
where $Z' = \ap((Z_1)_2, (Z_2)_1)$.

\end{enumerate}

Assume  $\phi_X(t) = \False$ 
and $t=c(t_1)\ldots(t_h)$ for some $h=0,1,2$ some $t_1, \ldots, t_h \in \LAMBDA_\bot$.
Then we set
\begin{enumerate}
\item
$\rho(t,X,n+1)  \ \ \ \ = c(\rho(t_1,X_1,n)\ldots(\rho(t_h,X_h,n)) $
\item
$\sigma(t,X,n+1,Z) = c(  \sigma(t_1,X_1,n,Z_1)\ldots \sigma(t_h,X_h,n,Z_h)  )$
 and $Z' = c(Z_1)\ldots(Z_h) = Z$.
\end{enumerate}
We define $\rho(t,X) = \lim_{n \rightarrow \infty} \rho(t,X,n)$ and 
$\sigma(t,X,Z) = \lim_{n \rightarrow \infty} \sigma(t,X,n,Z)$
and $t \reduces_X \rho(t,X)$.
\end{definition}

\begin{proposition}[Reduction and union]
\label{lemma-reduction-union}
Suppose $t, u \in \LAMBDA_\bot$
and $X$ are decidable sest of redexes of $t$ and $Y$ are decidable sets of redexes of $u$
and $l \in \universe{t}$. Let $X', Y', \ldots$ as in Def. \ref{definition-substitution-label}.
\begin{enumerate}
\item
$[Z \cup T / x] = [Z / x] \cup [T / x] $
\item
$(X \cup Y)[Z \cup T / x] = X[Z / x] \cup Y[T / x] $
\item
$(X \cup Y)_l = X_l \cup Y_l$
\item
$c(X_1 \cup Y_1) \ldots (X_n \cup Y_n) = c(X_1) \ldots (X_n) \cup c(Y_1) \ldots (Y_n)$
\item
$(X \cup Y)' = X' \cup Y'$
%\item
%$\sigma(t,Z,n,X \cup Y) =\sigma(t,Z,n,X) \cup \sigma(t,Z,n,Y)$ for all $n \in \N$
\end{enumerate}
\end{proposition}

We will prove that 
for all $t,u,v \in \LAMBDA_\bot$, all decidable sets $X$, $Y$ of redexes of $t$ we have
$\rho(\rho(t,X),Z)  = \rho(t,X \cup Y)$ for $Z = \sigma(t,X,Y)$.

We order $\LAMBDA_\bot$ with $t \le u$ if and only if $\universe{t} \subseteq \universe{u}$
and for all $l \in \universe{t}$ either $l$ has label $\bot$ in $\universe{t}$ or $l$ has the
same label in $\universe{t}$ and $\universe{u}$.

We prove $\rho(\rho(t,X),Z)  \le \rho(t,X \cup Y)$ (left-to-right implication)
and $\rho(t,X \cup Y) \le \rho(\rho(t,X),Z)$ (right-to-left implication).


\begin{lemma}[Infinite Church-Rosser (left-to-right)]
\label{lemma-infinite-church-rosser-left}
For all $t,u,v \in \LAMBDA_\bot$, all decidable sets $X$, $Y$ of redexes of $t$:
$\rho(\rho(t,X),Z)  \le \rho(t,X \cup Y)$ for $Z = \sigma(t,X,Y)$.
\end{lemma}


\begin{proof}
We have to prove that $\rho(\rho(t,X),Z)  = \rho(t,X \cup Y)$ for $Z = \sigma(t,X,Y)$.

Let us abbreviate $Y_{(n)} = \sigma(t,X,n,Y)$ 
and $Y_{(\omega)} = \lim_{n \rightarrow \infty} Y_{(n)} = Z$.
then $\rho(\rho(t,X),Z) = \rho(\rho(t,X),Y_{(\omega)} )) $
 is the limit of $\rho(\rho(t,X,n),Y_{(n)},m)$ for $n,m \rightarrow \infty$.

We prove that for all $n,m \in \N$
there is some $p \in \N$ such that  $\rho(\rho(t,X,n),Y_{(n)},m)  \le \rho(t,X \cup Y,p)$,
and conversely that for all $p \in \N$ there are $n,m\in\N$ such that 
$\rho(t,X \cup Y,p) \le \rho(\rho(t,X,n),Y_{(n)},m)$. It will follow that if a node
is defined in  $\rho(\rho(t,X),Z)$ then it is defined in $\rho(t,X \cup Y)$ and with the same 
constructor, and conversely.


$\rho(\rho(t,X,n),Y_{(n)},m)=\bot$ we are done, suppose 
$\rho(\rho(t,X,n),Y_{(n)},m) > \bot$.
If  $\phi_X(t) = \True$, then we have:

\begin{enumerate}
\item
If $t = (\lambda x^T.b)(a)$, 
then 
$\rho(t,X,n) = \rho(b[a/x],X',n-1)$,
and by induction hypothesis $\rho(\rho(t,X,n),Y_{(n)},m) = \rho(\rho(b[a/x],X',n-1),Y'_{(n-1)},m) 
\le \rho(b[a/x], X' \cup Y', p) =  \rho(b[a/x],(X \cup Y)', p) 
= \rho( (\lambda x^T.b)(a), X \cup Y, p + 1)$.

\item
If $t = \cond(f,g)(0)$, 
then 
$\rho(t,X,n+1) = \rho(f,X',n)$,
and by induction hypothesis $\rho(\rho(t,X,n),Y_{(n)},m) = \rho(\rho(f,X',n-1),Y'_{(n-1)},m) 
\le \rho(f, X' \cup Y, p) =  \rho(f, X' \cup Y', p) = \rho(f,(X \cup Y)', p) 
= \rho( t, X \cup Y, p + 1)$.

\item
If $t = \cond(f,g)(\Succ(u))$, 
then 
$\rho(t,X,n+1)= \rho(g(u),X',n)$ 
and by induction hypothesis $\rho(\rho(t,X,n),Y_{(n)},m) = \rho(\rho(f,X',n-1),Y'_{(n-1)},m) 
\le \rho(f, X' \cup Y', p) =  \rho(f,(X \cup Y)', p) 
= \rho( t, X \cup Y, p + 1)$.
\end{enumerate}

Assume  $\phi_X(t) = \False$. Then we have
$\rho(t,X,n)  = c(\rho(t_1,X_1,n-1)\ldots(\rho(t_h,X_h,n-1)) $
and $X = c(X_1) \ldots c(X_h)$.

Suppose $\phi_Y(t)=\True$.

\begin{enumerate}
\item
If $t = (\lambda x^T.b)(a)$, $\rho(t,X,n)  = (\lambda x^T.b')(a')$
then 
$\rho( (\lambda x^T.b')(a'),Y_{(n)},m) = \rho(b'[a'/x],Y'_{(n-1)},n-1)$,
and by induction hypothesis $\rho(b'[a'/x],Y'_{(n-1)},n-1) 
\le \rho(b'[a'/x], X \cup Y', p) =  \rho(b[a/x], X' \cup Y', p) = \rho(b[a/x],(X \cup Y)', p) 
= \rho( (\lambda x^T.b)(a), X \cup Y, p + 1)$.

\item
If $t = \cond(f,g)(0)$, $\rho(t,X,n)  =\cond(f',g')(0)$
then 
$\rho(t,X,n) = \rho(f,X',n-1)$,
and by induction hypothesis $\rho(\rho(t,X,n),Y_{(n)},m) = \rho(\rho(f,X',n-1),Y'_{(n-1)},m) 
\le \rho(f, X' \cup Y, p) =  \rho(f, X' \cup Y', p) = \rho(f,(X \cup Y)', p) 
= \rho( t, X \cup Y, p + 1)$.

\item
If $t = \cond(f,g)(\Succ(u))$, $\rho(t,X,n)  =\cond(f',g')(\Succ(u'))$
then $\rho(t,X,n)= \rho(g(u),X',n-1)$ 
and by induction hypothesis $\rho(\rho(t,X,n),Y_{(n)},m) = \rho(\rho(g(u),X',n-1),Y'_{(n-1)},m) 
\le \rho(g(u), X' \cup Y', p) =  \rho(g(u),(X \cup Y)', p) 
= \rho(g(u), X \cup Y, p + 1)$.
\end{enumerate}


Assume  $\phi_X(t) = \False$ and $\phi_Y(t)=\False$ and $t=c(t_1)\ldots(t_h)$ for some $h=0,1,2$.
Then $\rho(\rho(t,X,n),Y_{(n)},m) = 
c(\rho(\rho(t_1,X_1,n-1),(Y_{(n)})_1,m-1), \ldots, \rho(\rho(t_h,X_h,n-1),(Y_{(n)})_h,m-1)
= c(\rho(\rho(t_1,X_1,n),(Y_1)_{(n-1)},m), \ldots, \rho(\rho(t_h,X_h,n),(Y_h)_{(n-1)},m) 
 \le
c(\rho(t_1,X_1 \cup Y_1,p_1), \ldots, \rho(t_h,X_h \cup Y_h,p_h) =
c(\rho(t_1,(X \cup Y)_1,p_1), \ldots, \rho(t_h,(X \cup Y)_h,p_h)  \le
c(\rho(t_1,(X \cup Y)_1,p), \ldots, \rho(t_h,(X \cup Y)_h,p) =
\rho(t, X \cup Y,p)$ for $p = \max(p_1, \ldots, p_h)$.

\end{proof}

The proof of the opposite implication is similar.

\begin{lemma}[Infinite Church-Rosser (right-to-left)]
\label{lemma-infinite-church-rosser-right}
For all $t,u,v \in \LAMBDA_\bot$, all decidable sets $X$, $Y$ of redexes of $t$:
$\rho(t,X \cup Y) \le \rho(\rho(t,X),Z)$ for $Z = \sigma(t,X,Y)$.
\end{lemma}

\begin{proof}
\ldots\ldots\ldots
\end{proof}


\begin{theorem}[Infinite Church-Rosser]
\label{theorem-infinite-church-rosser}
For all $t,u,v \in \LAMBDA_\bot$, all decidable sets $X$, $Y$ of redexes of $t$:

\begin{enumerate}
\item
if $t \reduces_X u$ and $t \reduces_{X \cup Y} w$ and $Z = \sigma(t,X,Y)$ then 
$u \reduces_{Z} w$.


\item
if $t \reduces_X u$ and $u \reduces_Y v$, 
then for some $w \in \LAMBDA_\bot$, for some decidable sets
$Z$, $T$ of redexes of $u, v$
we have $u \reduces_Z w$ and $v  \reduces_T w$.
\end{enumerate}

\end{theorem}

\begin{proof}
\begin{enumerate}
\item
Assume if $t \reduces_X u$ and $t \reduces_{X \cup Y} w$ and $Z = \sigma(t,X,Y)$,
in order to prove $u \reduces_{Z} w$.
Then $u  = \rho(t,X)$ and $w = \rho(t,X \cup Y)$ and we have to prove  $\rho(u,Z)  = w$. 
This follows from $\rho(\rho(t,X),Z)  = \rho(t,X \cup Y)$ (lemmas
\label{lemma-infinite-church-rosser-left} and \label{lemma-infinite-church-rosser-right}).


%13:21 12/06/2024

\item
Assume $t \reduces_X u$ and $u \reduces_Y v$. There is some $w \in \LAMBDA_\bot$
such that $t \reduces_{X \cup Y} w$. From the previous point  we have
$u \reduces_{Z} w$ for $Z = \sigma(t,X,Y)$ and $v \reduces_{T} w$ for $T = \sigma(t,Y,X)$

\end{enumerate}
\end{proof}

We define the safe trunk of a term as the part of the term which we can normalize with safe reductions only.
In the rest of this section we will
prove that Infinite Church-Rosser implies that if the safe trunk exists then it is unique. 

Infinite Church-Rosser and Safe strong Normalization together imply that after finitely many steps
all safe reductions reach the same safe trunk.

\begin{definition}[Safe Trunk of a term]
\label{definition-safe-trunk}
Assume $t \in \LAMBDA$.
\begin{enumerate}
\item
The safe trunk of $t$ is any expression $u[\cond(f_1,\cdot), \ldots, \cond(f_n,\cdot)]$
such that  for some $g_1, \ldots, g_n$ we have $v = u[\cond(f_1,g_1), \ldots, \cond(f_n,g_n)]$
\emph{safe normal} and $t \reduces v$.
\item
$t$ is \emph{finite for safe reduction} if and only if all infinite reduction sequences from $t$ 
include only finitely many \quotationMarks{safe} reduction steps.  
\end{enumerate}
\end{definition}


\begin{lemma}[Safe Trunk of a term]
\label{lemma-safe-trunk}
Assume $t$ is finite for safe reductions.
If the  safe-trunk of $t$ exists then it is unique. 
\end{lemma}


\begin{proof}
Assume $t$ is finite for safe reductions in order to prove that the safe-trunk of $t$ is unique.

Assume that $u[\cond(f_1,\cdot), \ldots, \cond(f_n,\cdot)]$ and
$u'[\cond(f'_1,\cdot), \ldots, \cond(f'_{n'},\cdot)]$ are safe-trunks for $t$, in order to prove
that $u=u'$ and $n=n'$. 

Then for some $g_1, \ldots,g_n$ and some $g'_1, \ldots,g'_n$ we have that 
$v = u[\cond(f_1,g_1), \ldots, \cond(f_n,g_n)]$ and 
$v' = u'[\cond(f'_1,g'_1), \ldots, \cond(f'_n,g'_{n'})]$ 
are safe-normal forms of $t$ and all $\cond$-expressions shown are maximal. 
The decomposition of each safe-normal form $v$ is therefore unique:
if $v = u"[\cond(f"_1,g"_1), \ldots, \cond(f"_n,g"_{n"})]$ then $u=u"$ and $n=n"$
and $f_1=f"_1$, \ldots, $f_n=f"_n$.
Each reduction from $v$, $v'$ takes place in some $g_1, \ldots,g'_{n'}$. 

By Infinite Church-Rosser  
(theorem \ref{theorem-infinite-church-rosser}) we deduce that $v$ and $v'$ are confluent
outside the right-hand-side of $\cond$-expressions, therefore
for some $v"$ we have $v \reduces_Z v"$ and $v' \reduces_T v'"$. 
Since the reductions on $v, v'$ take place in some $g_1, \ldots,g'_{n'}$, 
we deduce that $v" = u[\cond(f_1,g"_1), \ldots, \cond(f_n,g"_n)]$
and $v'" = u[\cond(f'_1,g'"_1), \ldots, \cond(f'_n,g'"_{n'})]$ for some $g"_1, \ldots,g'"_{n'}$.
From the unicity of the decomposition of $v"$
with maximal $\cond$-subterms we conclude that $u=u'$ and $n=n'$
and and $f_1=f'_1$, \ldots, $f_n=f'_n$, as wished.

\end{proof}
